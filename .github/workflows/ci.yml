name: CI / CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [created]

env:
  PROJECT_NAME: gitignore

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  lint:
    name: Lint (Advisory)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install lint tools
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck

      - name: clang-format (check only)
        run: |
          FILES=$(find src -type f \( -name "*.c" -o -name "*.h" \))
          if [ -n "$FILES" ]; then
            echo "$FILES" | xargs clang-format -style=file -n || true
          else
            echo "No C files found; skipping format check"
          fi

      - name: cppcheck (warnings only)
        run: |
          cppcheck \
            --enable=warning,performance,portability \
            --inline-suppr \
            --suppress=missingIncludeSystem \
            src/ || true

  build:
    name: Build (${{ matrix.platform }} / ${{ matrix.arch }})
    needs: lint
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          # ---------- Linux ----------
          - platform: linux
            os: ubuntu-latest
            arch: x86_64
            cc: gcc
            native: true

          - platform: linux
            os: ubuntu-latest
            arch: arm64
            cc: aarch64-linux-gnu-gcc
            native: false

          # ---------- macOS ----------
          - platform: macos
            os: macos-latest
            arch: x86_64
            cc: clang
            native: true

          - platform: macos
            os: macos-latest
            arch: arm64
            cc: clang
            native: true

          # ---------- Windows ----------
          - platform: windows
            os: windows-latest
            arch: x86_64
            cc: x86_64-w64-mingw32-gcc
            native: false

          - platform: windows
            os: windows-latest
            arch: arm64
            cc: aarch64-w64-mingw32-gcc
            native: false

          # ---------- Android ----------
          - platform: android
            os: ubuntu-latest
            arch: arm64-v8a
            cc: aarch64-linux-android21-clang
            native: false

          - platform: android
            os: ubuntu-latest
            arch: x86_64
            cc: x86_64-linux-android21-clang
            native: false

    steps:
      - uses: actions/checkout@v4

      # ---------- Linux ----------
      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libcurl4-openssl-dev \
            gcc-aarch64-linux-gnu

      # ---------- macOS ----------
      - name: Install macOS dependencies
        if: matrix.platform == 'macos'
        run: brew install curl

      # ---------- Windows ----------
      - name: Install Windows dependencies
        if: matrix.platform == 'windows'
        run: choco install mingw llvm -y
        shell: powershell

      # ---------- Android ----------
      - name: Setup Android SDK
        if: matrix.platform == 'android'
        uses: android-actions/setup-android@v2

      - name: Install Android NDK
        if: matrix.platform == 'android'
        run: |
          sdkmanager "ndk;26.1.10909125"
          echo "$ANDROID_SDK_ROOT/ndk/26.1.10909125/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      # ---------- Build ----------
      - name: Build
        env:
          CC: ${{ matrix.cc }}
        run: |
          make clean || true
          make templates
          make

      # ---------- Native tests ----------
      - name: Run basic tests (native only)
        if: matrix.native == true
        run: |
          ./gitignore --version
          ./gitignore --help
          ./gitignore list

      # ---------- Rename binary ----------
      - name: Rename binary
        shell: bash
        run: |
          EXT=""
          if [[ "${{ matrix.platform }}" == "windows" ]]; then EXT=".exe"; fi
          mv gitignore gitignore-${{ matrix.platform }}-${{ matrix.arch }}$EXT

      # ---------- Upload ----------
      - uses: actions/upload-artifact@v4
        with:
          name: gitignore-${{ matrix.platform }}-${{ matrix.arch }}
          path: gitignore-${{ matrix.platform }}-${{ matrix.arch }}*

  security:
    name: Security Scan (Advisory)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          format: table

  release:
    name: Release
    if: github.event_name == 'release'
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4

      - name: Upload release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "${{ github.ref_name }}" gitignore-*/* --clobber
