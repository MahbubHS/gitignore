name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  release:
    types: [created]

env:
  PROJECT_NAME: gitignore
  VERSION: 2.0.0

jobs:
  lint:
    name: Code Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck

      - name: Run clang-format check
        run: |
          find src -name "*.c" -o -name "*.h" | xargs clang-format -style=file -n -Werror || true

      - name: Run cppcheck
        run: |
          cppcheck --enable=all --suppress=missingIncludeSystem src/ || true

  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            cc: gcc
          - os: macos-latest
            cc: clang

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libcurl4-openssl-dev

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install curl

      - name: Create templates
        run: make templates

      - name: Build
        env:
          CC: ${{ matrix.cc }}
        run: make

      - name: Run basic tests
        run: |
          ./gitignore --version
          ./gitignore list || true

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-${{ matrix.os }}
          path: ${{ env.PROJECT_NAME }}
          retention-days: 7

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libcurl4-openssl-dev

      - name: Build
        run: |
          make templates
          make

      - name: Test - Version
        run: ./gitignore --version

      - name: Test - Help
        run: ./gitignore --help

      - name: Test - List templates
        run: ./gitignore list

      - name: Test - Init empty
        run: |
          cd /tmp
          /workspaces/gitignore/gitignore init
          [ -f .gitignore ] && echo "✓ Empty init works"

      - name: Test - Auto detect
        run: |
          cd /tmp
          rm -f .gitignore
          echo '{}' > package.json
          /workspaces/gitignore/gitignore auto
          [ -f .gitignore ] && echo "✓ Auto detect works"
          grep -q "node" .gitignore && echo "✓ Node.js detected"

      - name: Test - Dry run
        run: ./gitignore --dry-run init python

      - name: Test - Add pattern
        run: |
          cd /tmp
          rm -f .gitignore
          /workspaces/gitignore/gitignore node_modules/
          [ -f .gitignore ] && echo "✓ Add pattern works"
          grep -q "node_modules/" .gitignore && echo "✓ Pattern added"

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'release'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        run: echo "VERSION=${{ github.event.release.tag_name#v }}" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libcurl4-openssl-dev

      - name: Build release
        run: |
          make templates
          make

      - name: Create tarball
        run: |
          mkdir -p dist/gitignore-${{ env.VERSION }}
          cp gitignore README.md LICENSE dist/gitignore-${{ env.VERSION }}/
          cp -r templates dist/gitignore-${{ env.VERSION }}/
          cd dist
          tar -czf gitignore-${{ env.VERSION }}-linux-x86_64.tar.gz gitignore-${{ env.VERSION }}

      - name: Upload release asset
        run: gh release upload ${{ github.event.release.tag_name }} ./dist/gitignore-${{ env.VERSION }}-linux-x86_64.tar.gz

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ env.VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  notify:
    name: Notify on Success
    runs-on: ubuntu-latest
    needs: [build, test]
    if: success()

    steps:
      - name: Send success notification
        run: |
          echo "✓ All checks passed!"
          echo "Build and tests completed successfully"
